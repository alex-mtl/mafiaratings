var widgStylesheet="editorContent.css",widgToolbarItems=[];widgToolbarItems.push("bold");widgToolbarItems.push("italic");widgToolbarItems.push("hyperlink");widgToolbarItems.push("unorderedlist");widgToolbarItems.push("orderedlist");widgToolbarItems.push("image");widgToolbarItems.push("htmlsource");widgToolbarItems.push("blockformat");var widgSelectBlockOptions=[];widgSelectBlockOptions.push("","Change block type");widgSelectBlockOptions.push("<h1>","Heading 1");
widgSelectBlockOptions.push("<h2>","Heading 2");widgSelectBlockOptions.push("<h3>","Heading 3");widgSelectBlockOptions.push("<h4>","Heading 4");widgSelectBlockOptions.push("<h5>","Heading 5");widgSelectBlockOptions.push("<h6>","Heading 6");widgSelectBlockOptions.push("<p>","Paragraph");var widgInsertParagraphs=!0,widgAutoClean=!1;
function widgInit(){if("string"==typeof document.designMode&&(document.all||"off"==document.designMode))for(var a=document.getElementsByTagName("textarea"),b=0;b<a.length;b++){var c=a[b];c.className.classExists("widgEditor")&&(""==c.id&&(c.id=c.name),setTimeout("new widgEditor('"+c.id+"')",500*b))}else return!1;return!0}
function widgEditor(a){this.theTextarea=document.getElementById(a);this.theContainer=document.createElement("div");this.theIframe=document.createElement("iframe");this.theInput=document.createElement("input");this.theExtraInput=document.createElement("input");this.IE=!1;this.locked=!0;this.pasteCache="";this.wysiwyg=!0;document.all&&(this.IE=!0);null==this.theTextarea.id&&(this.theTextarea.id=this.theTextarea.name);this.theTextarea.style.visibility="hidden";this.theContainer.id=this.theTextarea.id+
"WidgContainer";this.theContainer.className="widgContainer";this.theIframe.id=this.theTextarea.id+"WidgIframe";this.theIframe.className="widgIframe";this.theInput.type="hidden";this.theInput.id=this.theTextarea.id;this.theInput.name=this.theTextarea.name;this.theInput.value=this.theTextarea.value;this.theToolbar=new widgToolbar(this);this.theExtraInput.type="hidden";this.theExtraInput.id=this.theTextarea.id+"WidgEditor";this.theExtraInput.name=this.theTextarea.name+"WidgEditor";this.theExtraInput.value=
"true";this.theTextarea.id+="WidgTextarea";this.theTextarea.name+="WidgTextarea";this.theContainer.appendChild(this.theToolbar.theList);this.theContainer.appendChild(this.theIframe);this.theContainer.appendChild(this.theInput);this.theContainer.appendChild(this.theExtraInput);this.theContainer.style.visibility="hidden";this.theInput.widgEditorObject=this;this.theTextarea.parentNode.replaceChild(this.theContainer,this.theTextarea);this.writeDocument(this.theInput.value);this.initEdit();this.modifyFormSubmit();
return!0}
widgEditor.prototype.cleanPaste=function(){if(widgAutoClean||confirm("Do you wish to clean the HTML source of the content you just pasted?")){for(var a="",b="",c=this.theIframe.contentWindow.document.getElementsByTagName("body")[0].innerHTML,d=0,e=0,d="",f=document.createElement("div"),d=0;c.charAt(d)==this.pasteCache.charAt(d);d++)a+=this.pasteCache.charAt(d);for(var g=d;0<=g;g--)if("<"==this.pasteCache.charAt(g)){d=g;a=this.pasteCache.substring(0,d);break}else if(">"==this.pasteCache.charAt(g))break;c=
c.reverse();this.pasteCache=this.pasteCache.reverse();for(e=0;c.charAt(e)==this.pasteCache.charAt(e);e++)b+=this.pasteCache.charAt(e);for(g=e;0<=g;g--)if(">"==this.pasteCache.charAt(g)){e=g;b=this.pasteCache.substring(0,e);break}else if("<"==this.pasteCache.charAt(g))break;b=b.reverse();if(d==c.length-e)return!1;c=c.reverse();d=c.substring(d,c.length-e);d=d.validTags();d=d.replace(/<b(\s+|>)/g,"<strong$1");d=d.replace(/<\/b(\s+|>)/g,"</strong$1");d=d.replace(/<i(\s+|>)/g,"<em$1");d=d.replace(/<\/i(\s+|>)/g,
"</em$1");d=d.replace(/<[^>]*>/g,function(a){return a=a.replace(/ ([^=]+)="[^"]*"/g,function(a,b){return"alt"==b||"href"==b||"src"==b||"title"==b?a:""})});f.innerHTML=d;acceptableChildren(f);this.theInput.value=a+f.innerHTML+b;this.theInput.value=this.theInput.value.replace(/<\?xml[^>]*>/g,"");this.theInput.value=this.theInput.value.replace(/<[^ >]+:[^>]*>/g,"");this.theInput.value=this.theInput.value.replace(/<\/[^ >]+:[^>]*>/g,"");this.refreshDisplay();this.IE||this.convertSPANs()}return!0};
widgEditor.prototype.cleanSource=function(){var a="",a=this.wysiwyg?this.theIframe.contentWindow.document.getElementsByTagName("body")[0].innerHTML:this.theTextarea.value,a=a.validTags(),a=a.replace(/^\s+/,""),a=a.replace(/\s+$/,""),a=a.replace(/ style="[^"]*"/g,""),a=a.replace(/<br>/g,"<br />"),a=a.replace(/<br \/>\s*<\/(h1|h2|h3|h4|h5|h6|li|p)/g,"</$1"),a=a.replace(/(<img [^>]+[^\/])>/g,"$1 />"),a=a.replace(/(<[^\/]>|<[^\/][^>]*[^\/]>)\s*<\/[^>]*>/g,"");this.wysiwyg?this.theIframe.contentWindow.document.getElementsByTagName("body")[0].innerHTML=
a:this.theTextarea.value=a;this.theInput.value=a;return!0};
widgEditor.prototype.convertSPANs=function(a){if(a)for(var b=this.theIframe.contentWindow.document.getElementsByTagName("span");0<b.length;){a=[];for(var c=null,d=null,e=0;e<b[0].childNodes.length;e++)a.push(b[0].childNodes[e].cloneNode(!0));switch(b[0].getAttribute("style")){case "font-weight: bold;":d=c=this.theIframe.contentWindow.document.createElement("strong");break;case "font-style: italic;":d=c=this.theIframe.contentWindow.document.createElement("em");break;case "font-weight: bold; font-style: italic;":d=
this.theIframe.contentWindow.document.createElement("em");c=this.theIframe.contentWindow.document.createElement("strong");c.appendChild(d);break;case "font-style: italic; font-weight: bold;":d=this.theIframe.contentWindow.document.createElement("strong");c=this.theIframe.contentWindow.document.createElement("em");c.appendChild(d);break;default:replaceNodeWithChildren(b[0])}if(null!=c){for(e=0;e<a.length;e++)d.appendChild(a[e]);b[0].parentNode.replaceChild(c,b[0])}b=this.theIframe.contentWindow.document.getElementsByTagName("span")}else{for(c=
this.theIframe.contentWindow.document.getElementsByTagName("em");0<c.length;){a=[];b=this.theIframe.contentWindow.document.createElement("span");b.setAttribute("style","font-style: italic;");for(e=0;e<c[0].childNodes.length;e++)a.push(c[0].childNodes[e].cloneNode(!0));for(e=0;e<a.length;e++)b.appendChild(a[e]);c[0].parentNode.replaceChild(b,c[0]);c=this.theIframe.contentWindow.document.getElementsByTagName("em")}for(c=this.theIframe.contentWindow.document.getElementsByTagName("strong");0<c.length;){a=
[];b=this.theIframe.contentWindow.document.createElement("span");b.setAttribute("style","font-weight: bold;");for(e=0;e<c[0].childNodes.length;e++)a.push(c[0].childNodes[e].cloneNode(!0));for(e=0;e<a.length;e++)b.appendChild(a[e]);c[0].parentNode.replaceChild(b,c[0]);c=this.theIframe.contentWindow.document.getElementsByTagName("strong")}}return!0};
widgEditor.prototype.detectPaste=function(a){var b=null,b=a?a:event;if(b.ctrlKey&&86==b.keyCode&&this.wysiwyg){var c=this;this.pasteCache=this.theIframe.contentWindow.document.getElementsByTagName("body")[0].innerHTML;setTimeout(function(){c.cleanPaste();return!0},100)}return!0};
widgEditor.prototype.initEdit=function(){var a=this;try{this.theIframe.contentWindow.document.designMode="on"}catch(b){return setTimeout(function(){a.initEdit()},250),!1}this.IE||this.convertSPANs(!1);this.theContainer.style.visibility="visible";this.theTextarea.style.visibility="visible";"function"==typeof document.addEventListener?(this.theIframe.contentWindow.document.addEventListener("mouseup",function(){widgToolbarCheckState(a);return!0},!1),this.theIframe.contentWindow.document.addEventListener("keyup",
function(){widgToolbarCheckState(a);return!0},!1),this.theIframe.contentWindow.document.addEventListener("keydown",function(b){a.detectPaste(b);return!0},!1)):(this.theIframe.contentWindow.document.attachEvent("onmouseup",function(){widgToolbarCheckState(a);return!0}),this.theIframe.contentWindow.document.attachEvent("onkeyup",function(){widgToolbarCheckState(a);return!0}),this.theIframe.contentWindow.document.attachEvent("onkeydown",function(b){a.detectPaste(b);return!0},!1));this.locked=!1;return!0};
widgEditor.prototype.insertNewParagraph=function(a,b){for(var c=this.theIframe.contentWindow.document.getElementsByTagName("body")[0],d=this.theIframe.contentWindow.document.createElement("p"),e=0;e<a.length;e++)d.appendChild(a[e]);"undefined"!=typeof b?c.insertBefore(d,b):c.appendChild(d);return!0};
widgEditor.prototype.modifyFormSubmit=function(){for(var a=this,b=this.theContainer.parentNode,c=null;"form"!=b.nodeName.toLowerCase();)if(b=b.parentNode,null==b)return!1;c=b.onsubmit;b.onsubmit="function"!=typeof b.onsubmit?function(){return a.updateWidgInput()}:function(){a.updateWidgInput();return c()};return!0};
widgEditor.prototype.paragraphise=function(){if(widgInsertParagraphs&&this.wysiwyg){for(var a=this.theIframe.contentWindow.document.getElementsByTagName("body")[0],b=0;b<a.childNodes.length;b++)"#text"==a.childNodes[b].nodeName.toLowerCase()&&-1!=a.childNodes[b].data.search(/^\s*$/)&&(a.removeChild(a.childNodes[b]),b--);for(var c=[],b=0;b<a.childNodes.length;b++)if(a.childNodes[b].nodeName.isInlineName())c.push(a.childNodes[b].cloneNode(!0)),a.removeChild(a.childNodes[b]),b--;else if("br"==a.childNodes[b].nodeName.toLowerCase())if(b+
1<a.childNodes.length){if("br"==a.childNodes[b+1].nodeName.toLowerCase()){for(;b<a.childNodes.length&&"br"==a.childNodes[b].nodeName.toLowerCase();)a.removeChild(a.childNodes[b]);0<c.length&&(this.insertNewParagraph(c,a.childNodes[b]),c=[])}else a.childNodes[b+1].nodeName.isInlineName()&&0<c.length&&c.push(a.childNodes[b].cloneNode(!0)),a.removeChild(a.childNodes[b]);b--}else a.removeChild(a.childNodes[b]);else 0<c.length&&(this.insertNewParagraph(c,a.childNodes[b]),c=[]);0<c.length&&this.insertNewParagraph(c)}return!0};
widgEditor.prototype.refreshDisplay=function(){this.wysiwyg?this.theIframe.contentWindow.document.getElementsByTagName("body")[0].innerHTML=this.theInput.value:this.theTextarea.value=this.theInput.value;return!0};
widgEditor.prototype.switchMode=function(){this.locked||(this.locked=!0,this.wysiwyg?(this.updateWidgInput(),this.theTextarea.value=this.theInput.value,this.theContainer.replaceChild(this.theTextarea,this.theIframe),this.theToolbar.disable(),this.locked=this.wysiwyg=!1):(this.updateWidgInput(),this.theContainer.replaceChild(this.theIframe,this.theTextarea),this.writeDocument(this.theInput.value),this.theToolbar.enable(),this.initEdit(),this.wysiwyg=!0));return!0};
widgEditor.prototype.updateWidgInput=function(){this.wysiwyg?(this.IE||this.convertSPANs(!0),this.paragraphise(),this.cleanSource()):this.theInput.value=this.theTextarea.value;return!0};
widgEditor.prototype.writeDocument=function(a){var b='\t\t<html>\t\t\t<head>\t\t\t\tINSERT:STYLESHEET:END\t\t\t</head>\t\t\t<body id="iframeBody">\t\t\t\tINSERT:CONTENT:END\t\t\t</body>\t\t</html>\t',b="undefined"!=typeof document.all?b.replace(/INSERT:STYLESHEET:END/,'<link rel="stylesheet" type="text/css" href="'+widgStylesheet+'"></link>'):b.replace(/INSERT:STYLESHEET:END/,""),b=b.replace(/INSERT:CONTENT:END/,a);this.theIframe.contentWindow.document.open();this.theIframe.contentWindow.document.write(b);
this.theIframe.contentWindow.document.close();"undefined"==typeof document.all&&(a=this.theIframe.contentWindow.document.createElement("link"),a.setAttribute("rel","stylesheet"),a.setAttribute("type","text/css"),a.setAttribute("href",widgStylesheet),this.theIframe.contentWindow.document.getElementsByTagName("head")[0].appendChild(a));return!0};
function widgToolbar(a){this.widgEditorObject=a;this.theList=document.createElement("ul");this.theList.id=this.widgEditorObject.theInput.id+"WidgToolbar";this.theList.className="widgToolbar";this.theList.widgToolbarObject=this;for(a=0;a<widgToolbarItems.length;a++)switch(widgToolbarItems[a]){case "bold":this.addButton(this.theList.id+"ButtonBold","widgButtonBold","Bold","bold");break;case "italic":this.addButton(this.theList.id+"ButtonItalic","widgButtonItalic","Italic","italic");break;case "hyperlink":this.addButton(this.theList.id+
"ButtonLink","widgButtonLink","Hyperlink","link");break;case "unorderedlist":this.addButton(this.theList.id+"ButtonUnordered","widgButtonUnordered","Unordered List","insertunorderedlist");break;case "orderedlist":this.addButton(this.theList.id+"ButtonOrdered","widgButtonOrdered","Ordered List","insertorderedlist");break;case "image":this.addButton(this.theList.id+"ButtonImage","widgButtonImage","Insert Image","image");break;case "htmlsource":this.addButton(this.theList.id+"ButtonHTML","widgButtonHTML",
"HTML Source","html");break;case "blockformat":this.addSelect(this.theList.id+"SelectBlock","widgSelectBlock",widgSelectBlockOptions,"formatblock")}return!0}
widgToolbar.prototype.addButton=function(a,b,c,d){var e=document.createElement("li"),f=document.createElement("a"),g=document.createTextNode(c);e.id=a;e.className="widgEditButton";f.href="#";f.title=c;f.className=b;f.action=d;f.onclick=widgToolbarAction;f.onmouseover=widgToolbarMouseover;f.appendChild(g);e.appendChild(f);this.theList.appendChild(e);return!0};
widgToolbar.prototype.addSelect=function(a,b,c,d){var e=document.createElement("li"),f=document.createElement("select");e.className="widgEditSelect";f.id=a;f.name=a;f.className=b;f.action=d;f.onchange=widgToolbarAction;for(a=0;a<c.length;a+=2)b=document.createElement("option"),d=document.createTextNode(c[a+1]),b.value=c[a],b.appendChild(d),f.appendChild(b);e.appendChild(f);this.theList.appendChild(e);return!0};
widgToolbar.prototype.disable=function(){this.theList.className+=" widgSource";for(var a=0;a<this.theList.childNodes.length;a++){var b=this.theList.childNodes[a];if("li"==b.nodeName.toLowerCase()&&"widgEditSelect"==b.className)for(j=0;j<b.childNodes.length;j++)if("select"==b.childNodes[j].nodeName.toLowerCase()){b.childNodes[j].disabled="disabled";break}}return!0};
widgToolbar.prototype.enable=function(){this.theList.className=this.theList.className.replace(/ widgSource/,"");for(var a=0;a<this.theList.childNodes.length;a++){var b=this.theList.childNodes[a];if("li"==b.nodeName.toLowerCase()&&"widgEditSelect"==b.className)for(j=0;j<b.childNodes.length;j++)if("select"==b.childNodes[j].nodeName.toLowerCase()){b.childNodes[j].disabled="";break}}return!0};
widgToolbar.prototype.setState=function(a,b){if("SelectBlock"!=a){var c=document.getElementById(this.theList.id+"Button"+a);null!=c&&(c.className="on"==b?c.className.addClass("on"):c.className.removeClass("on"))}else c=document.getElementById(this.theList.id+"SelectBlock"),null!=c&&(c.value="",c.value=b);return!0};
function widgToolbarAction(){var a=this.parentNode.parentNode.widgToolbarObject.widgEditorObject,b=a.theIframe,c="";if(!a.wysiwyg&&"html"!=this.action)return!1;switch(this.action){case "formatblock":b.contentWindow.document.execCommand(this.action,!1,this.value);a.theToolbar.setState("SelectBlock",this.value);break;case "html":a.switchMode();break;case "link":if(this.parentNode.className.classExists("on"))b.contentWindow.document.execCommand("Unlink",!1,null),a.theToolbar.setState("Link","off");else{c=
b.contentWindow.document.selection?b.contentWindow.document.selection.createRange().text:b.contentWindow.getSelection();if(""==c){alert("Please select the text you wish to hyperlink.");break}var d=prompt("Enter the URL for this link:","http://");null!=d&&(b.contentWindow.document.execCommand("CreateLink",!1,d),a.theToolbar.setState("Link","on"))}break;case "image":if(d=prompt("Enter the location for this image:",""),null!=d&&""!=d){var e=prompt("Enter the alternate text for this image:",""),f=c=null;
if(b.contentWindow.document.selection)e=e.replace(/"/g,"'"),c=b.contentWindow.document.selection,f=c.createRange(),f.collapse(!1),f.pasteHTML('<img alt="'+e+'" src="'+d+'" />');else{try{c=b.contentWindow.getSelection()}catch(g){return!1}f=c.getRangeAt(0);f.collapse(!1);c=b.contentWindow.document.createElement("img");c.src=d;c.alt=e;f.insertNode(c)}break}else return!1;default:b.contentWindow.document.execCommand(this.action,!1,null),d=this.action.replace(/^./,function(a){return a.toUpperCase()}),"insertorderedlist"==
this.action&&(d="Ordered",a.theToolbar.setState("Unordered","off")),"insertunorderedlist"==this.action&&(d="Unordered",a.theToolbar.setState("Ordered","off")),b.contentWindow.document.queryCommandState(this.action,!1,null)?a.theToolbar.setState(d,"on"):a.theToolbar.setState(d,"off")}!0==a.wysiwyg?b.contentWindow.focus():a.theTextarea.focus();return!1}
function widgToolbarCheckState(a,b){b||setTimeout(function(){widgToolbarCheckState(a,!0);return!0},500);for(var c=null,d=null,e=null,f=0,d=a.theToolbar.theList.childNodes,g=0;g<d.length;g++)d[g].className=d[g].className.removeClass("on");if(a.theIframe.contentWindow.document.selection){c=a.theIframe.contentWindow.document.selection;d=c.createRange();try{e=d.parentElement()}catch(h){return!1}}else{try{c=a.theIframe.contentWindow.getSelection()}catch(k){return!1}d=c.getRangeAt(0);e=d.commonAncestorContainer}for(;3==
e.nodeType;)e=e.parentNode;for(;"body"!=e.nodeName.toLowerCase();){switch(e.nodeName.toLowerCase()){case "a":a.theToolbar.setState("Link","on");break;case "em":a.theToolbar.setState("Italic","on");break;case "li":break;case "ol":a.theToolbar.setState("Ordered","on");a.theToolbar.setState("Unordered","off");break;case "span":"font-weight: bold;"==e.getAttribute("style")?a.theToolbar.setState("Bold","on"):"font-style: italic;"==e.getAttribute("style")?a.theToolbar.setState("Italic","on"):"font-weight: bold; font-style: italic;"==
e.getAttribute("style")?(a.theToolbar.setState("Bold","on"),a.theToolbar.setState("Italic","on")):"font-style: italic; font-weight: bold;"==e.getAttribute("style")&&(a.theToolbar.setState("Bold","on"),a.theToolbar.setState("Italic","on"));break;case "strong":a.theToolbar.setState("Bold","on");break;case "ul":a.theToolbar.setState("Unordered","on");a.theToolbar.setState("Ordered","off");break;default:a.theToolbar.setState("SelectBlock","<"+e.nodeName.toLowerCase()+">")}e=e.parentNode;f++}return!0}
function widgToolbarMouseover(){window.status="";return!0}function acceptableChildren(a){for(var b=a.childNodes,c=0;c<b.length;c++)if(!b[c].nodeName.isAcceptedElementName()){if(b[c].nodeName.isInlineName())replaceNodeWithChildren(b[c]);else{if("p"==a.nodeName.toLowerCase())return acceptableChildren(replaceNodeWithChildren(a)),!0;changeNodeType(b[c],"p")}c=-1}for(c=0;c<b.length;c++)acceptableChildren(b[c]);return!0}
function changeNodeType(a,b){var c=[],d=document.createElement(b),e=a.parentNode;if(null!=e){for(var f=0;f<a.childNodes.length;f++)c.push(a.childNodes[f].cloneNode(!0));for(f=0;f<c.length;f++)d.appendChild(c[f]);e.replaceChild(d,a)}return!0}function replaceNodeWithChildren(a){var b=[],c=a.parentNode;if(null!=c){for(var d=0;d<a.childNodes.length;d++)b.push(a.childNodes[d].cloneNode(!0));for(d=0;d<b.length;d++)c.insertBefore(b[d],a);c.removeChild(a);return c}return!0}
String.prototype.addClass=function(a){if(""!=this){if(!this.classExists(a))return this+" "+a}else return a;return this};String.prototype.classExists=function(a){return RegExp("(^| )"+a+"W*").test(this)?!0:!1};String.prototype.isAcceptedElementName=function(){for(var a="#text a em h1 h2 h3 h4 h5 h6 img li ol p strong ul".split(" "),b=this.toLowerCase(),c=0;c<a.length;c++)if(b==a[c])return!0;return!1};
String.prototype.isInlineName=function(){for(var a="#text a em font span strong u".split(" "),b=this.toLowerCase(),c=0;c<a.length;c++)if(b==a[c])return!0;return!1};String.prototype.removeClass=function(a){return this.replace(RegExp("(^| )"+a+"W*"),"")};String.prototype.reverse=function(){for(var a="",b=this.length-1;0<=b;b--)a+=this.charAt(b);return a};
String.prototype.validTags=function(){var a;a=this.replace(/<[^> ]*/g,function(a){return a.toLowerCase()});a=a.replace(/<[^>]*>/g,function(a){return a=a.replace(/ [^=]+=/g,function(a){return a.toLowerCase()})});return a=a.replace(/<[^>]*>/g,function(a){return a=a.replace(/( [^=]+=)([^"][^ >]*)/g,'$1"$2"')})};
