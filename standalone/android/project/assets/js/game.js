var mafia=new function(){function D(a,b){a=0<a?a:0;b=0<b?b:0;var c=0<a!=0<A||0<b!=0<s;A=a;s=b;c&&null!=E&&E(0<a,0<b)}function k(){D(1,s+1)}function M(a){for(var b=0;b<e.nominants.length;++b)if(e.nominants[b].player_num==a)return b;return-1}function F(a){var b=f.game;if(a){a=e;e={round:e.round,nominants:[],voting_round:e.voting_round,multiple_kill:!1,canceled:0};e.votes=b.flags&2?null:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];for(var c=0;c<a.nominants.length;++c){var d=a.nominants[c];if(0==b.players[d.player_num].state)G(d.player_num,
d.nominated_by);else if(0==(b.flags&2))for(d=0;10>d;++d){var g=a.votes[d];g>=c&&--g;0<=g&&H(d,g)}}b.votings.push(e)}else 1<b.votings.length&&(a=b.votings[b.votings.length-2],e.round==a.round&&e.voting_round==a.voting_round&&(b.votings.pop(),e=a))}function O(a,b){var c=f.game,d=mafia.gameRules.flags&192;switch(b){case 2:case 3:case 1:switch(c.gamestate){case 3:case 5:case 8:case 10:case 9:if(0!=a.state){e.canceled+=2;var g=M(a.number);(64==d||128==d&&0>g)&&0==(e.canceled&1)&&F(!0)}else 1>=e.canceled&&
F(!1),e.canceled-=2}}if(2<=a.role)if(0!=a.state)"undefined"!=typeof c.shooting[c.round]&&delete c.shooting[c.round][a.number];else if("undefined"!=typeof c.shooting[c.round]){g=-1;for(d=0;10>d;++d)if(c.players[d].arranged==c.round){g=d;break}c.shooting[c.round][a.number]=g}if(0!=a.state){for(var m=g=0,d=0;10>d;++d){var j=c.players[d];0==j.state&&(1>=j.role?++m:++g)}if(0>=g||m<=g)c.gamestate=25}}function u(a,b,c,d){a=f.game.players[a];0==a.state&&(a.state=b?1:2,a.kill_round=d,a.kill_reason=c,O(a,c))}
function x(a){try{var b=f.game.players[a];if(0!=b.state){var c=b.kill_reason;b.state=0;b.kill_round=-1;b.kill_reason=-1;O(b,c)}}catch(d){handleError(d)}}function G(a,b){var c=f.game;"undefined"==typeof a?(a=c.current_nominant,b=c.player_speaking):"undefined"==typeof b&&(b=c.player_speaking);if(0>=e.canceled&&0==c.players[a].state){for(var d in e.nominants)if(e.nominants[d].player_num==a)return!1;c=e.nominants.length;e.nominants.push({player_num:a,nominated_by:b,count:0});if(f.game.flags&2)r=null;
else for(d=0;10>d;++d)H(d,c);return!0}return!1}function I(){if(0>=e.canceled){var a=e.nominants.length-1;e.nominants.splice(a,1);if(0==(f.game.flags&2))for(var b=e.votes,c=0;10>c;++c)b[c]>a?--b[c]:b[c]==a&&H(c,-1)}}function H(a,b){if(0>=e.canceled&&0==(f.game.flags&2)){var c=e.votes[a];0<=c&&c<e.nominants.length&&--e.nominants[c].count;if(0!=f.game.players[a].state)e.votes[a]=-1;else{if(0>b||b>=e.nominants.length)b=e.nominants.length-1;e.votes[a]=b;0<=b&&++e.nominants[b].count}r=null}}function N(a){for(var b=
f.game;;){var c=Math.floor(10*Math.random()),c=b.players[c];if(0==c.role){c.role=a;break}}}function p(a){var b=f.game,c=0,d=null;null!=e&&e.round==a&&(d=mafia.votingWinners(),c=1);e={round:a,nominants:[],voting_round:c,multiple_kill:!1,canceled:0};e.votes=b.flags&2?null:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];if(null!=d)for(var g in d)G(d[g],-1);b.votings.push(e)}function n(a,b){"undefined"!=typeof b&&f.game.log.push(b);B||(f.game.end_time=mafia.time());k();null!=h&&h(a)}var A=0,s=0,f=null,J,v,w,C,h=null,
E=null,K=null,B,t=0,L=0,e=null,r=null,y=0,z=null;this.gameRules=null;this.sPlayers=function(){return J};this.sReg=function(a){return v[a]};this.sEvents=function(){return w};this.sRules=function(){return C};this.load=function(){if("object"==typeof localStorage){var a=localStorage.data;"undefined"!=typeof a&&null!=a&&(mafia.data(jQuery.parseJSON(a)),D(0,f.dirty))}};this.save=function(a){"boolean"!=typeof a&&(a=!1);if(null!=f&&(0<A||a))"object"==typeof localStorage&&(f.dirty=s,localStorage.data=JSON.stringify(f)),
D(0,s)};this.stateChange=function(a){var b=h;"function"==typeof a&&(h=a);return b};this.editing=function(a){var b=B;"boolean"==typeof a&&(B=a);return b};this.failEvent=function(a){var b=K;"function"==typeof a&&(K=a);return b};this.localDirty=function(){return 0<A};this.globalDirty=function(){return 0<s};this.dirtyEvent=function(a){var b=E;"function"==typeof a&&(E=a);return b};this.data=function(a){if("object"==typeof a){var b=0;null==f?b=3:f.club.id!=a.club.id&&(b=2);var c=function(a,b){return g[a].name.toLocaleLowerCase().localeCompare(g[b].name.toLocaleLowerCase())};
f=a;var d=a.club,g=d.players;a=a.game;J=[];for(var m in g)J.push(m),m=parseInt(m),m<L&&(L=m);J.sort(c);d.haunters.sort(c);var j=d.events;if("undefined"!=typeof j[0])z=j[0];else if(null==z||z.club_id!=d.id)z={id:0,club_id:d.id,rules_id:d.rules_id,name:l("DemoEvent"),start_time:0,duration:4294967295,langs:d.langs,flags:0,reg:{}};j[0]=z;c=j[a.event_id];"undefined"==typeof c&&(a.event_id=0,c=z);for(var k=0;10>k;++k){var q=a.players[k],n=c.reg;if(0!=q.id){var r=g[q.id];"undefined"==typeof r?q.id=0:"undefined"==
typeof n[q.id]&&(n[q.id]=r.name)}}w=[];v={};for(m in j){w.push(m);m<t&&(t=m);var p=j[m].reg,q=[];for(k in p)q.push(k);q.sort(function(a,b){return p[a].toLocaleLowerCase().localeCompare(p[b].toLocaleLowerCase())});v[m]=q}w.sort(function(a,b){return j[a].start_time-j[b].start_time});var s=d.rules;C=[];for(m in s)C.push(m);C.sort(function(a,b){return s[a].name.toLocaleLowerCase().localeCompare(s[b].name.toLocaleLowerCase())});"undefined"==typeof f.requests&&(f.requests=[]);e=null;null!=a.votings&&0<
a.votings.length&&(e=a.votings[a.votings.length-1]);mafia.gameRules=d.rules[a.rules_id];"undefined"==typeof mafia.gameRules&&(a.rules_id=C[0],mafia.gameRules=d.rules[a.rules_id]);if(0==a.lang||0!=(a.lang-1&a.lang))a.lang=0==(c.langs-1&c.langs)?c.langs:0==(d.langs-1&d.langs)?d.langs:0;0==a.moder_id&&(a.moder_id=c.flags&8?0:f.user.id);null!=h&&h(b);"string"==typeof f.fail&&null!=K&&K(f.fail)}return f};this.time=function(){return Math.round((new Date).getTime()/1E3)};this.sync=function(a,b,c){++y;if(!(1<
y&&5>y)){y=1;"number"!=typeof a&&(a=0);"number"!=typeof b&&(b=0);null==f&&mafia.load();request={sync:""};null!=f&&(0>=a&&(a=f.game.club_id),0>=b&&(b=f.game.event_id),0<s&&(request.game=JSON.stringify(f.game),0<f.requests.length&&(request.data=JSON.stringify(f.requests))));0<a&&(request.club=a);var d=s;json.post("game_ops.php",request,function(a){D(A,s-d);y=0;if("undefined"!=typeof a.club){"undefined"!=typeof a.club.events[b]&&(a.game.event_id=b);switch(a.game.gamestate){case 17:case 18:a.game.gamestate=
25}mafia.data(a)}mafia.save(!0);"undefined"!=typeof c&&c()},function(){y=0;http.connected(!1)})}};this.player=function(a,b){var c=f.game,d=f.club,g=d.events[c.event_id],e=-1;if(10==a){if(0==c.gamestate&&g.flags&8){c.moder_id=b;if(0!=b)for(g=0;10>g;++g)d=c.players[g],d.id==b&&(d.id=0,d.nick="",d.warnings=0,e=g);k()}}else{var j="",h=1,q=0;if(0!=b){q=d.players[b];j=g.reg[b];h=q.flags&64?1:0;q=q.flags&1024?1:0;if(b==c.moder_id){if(0!=c.gamestate||0==(g.flags&8))return-1;c.moder_id=0;e=10}for(g=0;10>g;++g)d=
c.players[g],g!=a&&d.id==b&&(d.id=0,d.nick="",e=g)}d=c.players[a];d.id=b;d.nick=j;d.is_male=h;d.has_immunity=q;k()}return e};this.userTitle=function(a){if(0==a)return"";var b=f.club.players[a].name,c=f.club.events[f.game.event_id];"undefined"!=typeof c&&(a=c.reg[a],"undefined"!=typeof a&&a.toLocaleLowerCase()!=b.toLocaleLowerCase()&&(b=a+" ("+b+")"));return b};this.playerTitle=function(a){var b=f.game.players[a].id;return 0==b?a+1:mafia.userTitle(b)};this.findPlayer=function(a){var b=null,c=!0;a=
a.toLocaleLowerCase();for(var d in f.club.players){var g=f.club.players[d];if(g.name.toLocaleLowerCase()==a)return g;if(c)for(var e in g.nicks)if(e.toLocaleLowerCase()==a){null==b?b=g:(c=!1,b=null);break}}return b};this.eventId=function(a){var b=f.game,c=b.event_id;if(b.event_id!=a){var d=f.club,g=d.events[a];b.event_id=a;b.moder_id=g.flags&8?0:f.user.id;b.lang=parseInt(g.langs);b.rules_id="undefined"==typeof d.rules[g.rules_id]?d.rules_id:g.rules_id;b.lang-1&b.lang&&(b.lang=0);for(a=0;10>a;++a)d=
b.players[a],d.id=0,d.nick="";k()}return c};this.createEvent=function(a){if("undefined"==typeof a.addr_id&&0==$.trim(a.addr).length)throw l("ErrNoAddr");var b=mafia.time();--t;a.id=t;a.action="new-event";a.time=mafia.time();a.start=b;f.requests.push(a);var c=f.club.events;c[t]={id:t,rules_id:a.rules,name:a.name,start_time:b,langs:a.langs,duration:a.duration,flags:a.flags,reg:{}};w=[];for(var d in c)w.push(d);w.sort(function(a,b){return c[a].start_time-c[b].start_time});v[t]=[];return t};this.extendEvent=
function(a,b){var c=f.club.events[a],d=mafia.time()+parseInt(b);c.duration=d-c.start_time;c={action:"extend-event",time:mafia.time(),id:a,duration:c.duration};f.requests.push(c);k()};this.register=function(a,b){var c=f.club.events[f.game.event_id];if("undefined"!=typeof c){var d=c.reg;"undefined"==typeof d[b]&&(d[b]=a,c=v[c.id],c.push(b),c.sort(function(a,b){return d[a].toLocaleLowerCase().localeCompare(d[b].toLocaleLowerCase())}),0!=f.game.event_id&&(d={action:"reg",time:mafia.time(),id:b,nick:a,
event:f.game.event_id},f.requests.push(d)),k())}};this.regIncomer=function(a,b,c,d){var g=f.club,e=g.events[f.game.event_id];if("undefined"!=typeof e&&0!=e.id){if("undefined"==typeof c||0==c)c=--L,d=65;g=g.players;"undefined"==typeof g[c]&&(g[c]={id:c,name:a,flags:d,nicks:{}});var j=e.reg;"undefined"==typeof j[c]&&(j[c]=b,e=v[e.id],e.push(c),e.sort(function(a,b){return j[a].toLocaleLowerCase().localeCompare(j[b].toLocaleLowerCase())}),b={action:"reg-incomer",time:mafia.time(),nick:b,event:f.game.event_id,
flags:d,id:c},0>=c&&(b.name=a),f.requests.push(b));k()}return c};this.checkUser=function(a){var b=f.club;if(0==b.events[f.game.event_id].id)return l("ErrDemo");a=a.trim();if(""==a)return l("ErrNoName");var c=a.toLocaleLowerCase(),d;for(d in b.players)if(b.players[d].name.toLocaleLowerCase()==c)return l("ErrUserExists",a);return null};this.createUser=function(a,b,c,d){var g=f.club,e=g.events[f.game.event_id],j=g.players;a=a.trim();c=c.trim();g=mafia.checkUser(a);if(null!=g)throw g;g=--L;j[g]={id:g,
name:a,flags:d,nicks:{}};var h=e.reg;h[g]=b;j=v[e.id];j.push(g);j.sort(function(a,b){return h[a].toLocaleLowerCase().localeCompare(h[b].toLocaleLowerCase())});a={action:"new-user",time:mafia.time(),name:a,nick:b,email:c,event:e.id,flags:d,id:g};f.requests.push(a);k();return g};this.canBack=function(){return null!=f.game.log&&0<f.game.log.length};this.canNext=function(){var a=f.game;return 0!=a.gamestate||0!=a.moder_id&&0!=a.lang&&0<a.rules_id};this.canRestart=function(){return 0<f.game.gamestate};
this.setRules=function(a){if(f.game.rules_id!=a){var b=f.club.rules[a];"undefined"!=typeof b&&(f.game.rules_id=a,mafia.gameRules=b,k())}};this.setLang=function(a){a-1&a&&(a=0);f.game.lang!=a&&(f.game.lang=a,k())};this.getNominationIndex=function(a){return M(a)};this.isNominated=function(a){return 0<=M(a)};this.votingWinners=function(){if(null==r||r.round!=e.round||r.voting_round!=e.voting_round)if(r={winners:[],round:e.round,voting_round:e.voting_round},f.game.flags&2){1==e.nominants.length&&(e.nominants[0].count=
1);for(var a in e.nominants){var b=e.nominants[a];0!=b.count&&r.winners.push(b.player_num)}}else{var c=0;for(a in e.nominants)b=e.nominants[a],0!=b.count&&(b.count>c?(c=b.count,r.winners=[b.player_num]):b.count==c&&r.winners.push(b.player_num))}return r.winners};this.whoMurdered=function(){var a=mafia.shots(),b=-1,c;for(c in a){var d=a[c];if(0>d)return-1;if(0>b)b=d;else if(b!=d)return-1}return b};this.playersCount=function(a){for(var b=f.game,c=0,d=0;10>d;++d){var e=b.players[d];0==e.state&&("undefined"==
typeof a||a&&1>=e.role||!a&&1<e.role)&&++c}return c};this.generateRoles=function(a){"undefined"==typeof a&&(a=!0);for(var b=f.game,c=0,d=0,e=0,m=0;10>m;++m){var j=b.players[m];switch(j.role){case 1:a||1==e?j.role=0:++e;break;case 2:a||2==c?j.role=0:++c;break;case 3:a||1==d?j.role=0:++d;break;default:j.role=0}}for(;1>e++;)N(1);for(;2>c++;)N(2);for(;1>d++;)N(3);a&&(k(),null!=h&&h(0))};this.next=function(){var a=f.game,b={type:0,round:a.round,gamestate:a.gamestate,player_speaking:a.player_speaking,current_nominant:a.current_nominant,
player:-1};switch(a.gamestate){case 0:if(!mafia.canNext())throw l("ErrGameNotReady");a.flags=mafia.gameRules.flags&2048||mafia.gameRules.flags&4096&&f.user.settings.flags&1?a.flags|2:a.flags&-3;mafia.generateRoles(!1);a.gamestate=1;a.round=0;a.player_speaking=-1;a.current_nominant=-1;a.table_opener=0;mafia.gameRules=f.club.rules[a.rules_id];a.votings=[];p(0);a.shooting=[];a.log=[];B||(a.start_time=mafia.time());break;case 1:a.gamestate=2;break;case 2:a.gamestate=3;break;case 3:0<=a.current_nominant&&
(G(),a.current_nominant=-1);0!=(mafia.gameRules.flags&1024)&&1==a.round&&0<=a.player_speaking?a.gamestate=21:0!=(mafia.gameRules.flags&2)?(a.gamestate=20,a.player_speaking=-1):(a.gamestate=5,a.player_speaking=mafia.nextPlayer(-1));break;case 21:0!=(mafia.gameRules.flags&2)?(a.gamestate=20,a.player_speaking=-1):(a.gamestate=5,a.player_speaking=mafia.nextPlayer(-1));break;case 20:a.gamestate=5;a.player_speaking=mafia.nextPlayer(-1);break;case 5:0<=a.current_nominant&&G();a.current_nominant=-1;a.player_speaking=
mafia.nextPlayer(a.player_speaking);if(0>a.player_speaking)if(0<e.canceled)a.gamestate=11,p(a.round+1);else switch(e.nominants.length){case 0:a.gamestate=11;p(a.round+1);break;case 1:0==(mafia.gameRules.flags&36)&&0==a.round?(a.gamestate=11,p(a.round+1)):(a.gamestate=7,a.current_nominant=0,a.player_speaking=mafia.votingWinners()[0],mafia.isKillingThisDay()&&u(a.player_speaking,!1,0,a.round));break;default:a.current_nominant=0,a.player_speaking=e.nominants[0].player_num,a.gamestate=mafia.isDefenciveRoundThisDay()?
10:8}break;case 7:++a.current_nominant>=mafia.votingWinners().length?(a.gamestate=11,p(a.round+1),a.player_speaking=-1,a.current_nominant=-1):a.player_speaking=mafia.votingWinners()[a.current_nominant];break;case 8:if(0<e.canceled)a.gamestate=11,p(a.round+1),a.player_speaking=-1,a.current_nominant=-1;else if(0==(a.flags&2)&&a.current_nominant<e.nominants.length-1)a.player_speaking=e.nominants[++a.current_nominant].player_num;else switch(mafia.votingWinners().length){case 0:return;case 1:a.gamestate=
7;a.current_nominant=0;a.player_speaking=mafia.votingWinners()[0];mafia.isKillingThisDay()&&u(a.player_speaking,!1,0,a.round);break;default:a.gamestate=9,a.current_nominant=-1,a.player_speaking=-1}break;case 9:if(0==e.voting_round)mafia.isKillingThisDay()?0<e.canceled||4==mafia.playersCount()&&0!=(mafia.gameRules.flags&8)?(a.gamestate=11,p(a.round+1),a.player_speaking=-1,a.current_nominant=-1):(p(a.round),a.current_nominant=0,a.gamestate=a.current_nominant>=e.nominants.length?8:10,a.player_speaking=
e.nominants[a.current_nominant].player_num):(a.current_nominant=0,a.current_nominant>=mafia.votingWinners().length?(a.gamestate=11,p(a.round+1),a.player_speaking=-1,a.current_nominant=-1):(a.gamestate=7,a.player_speaking=mafia.votingWinners()[a.current_nominant]));else if(!e.multiple_kill||3==mafia.playersCount())a.gamestate=11,p(a.round+1);else{a.gamestate=7;a.current_nominant=0;var c=mafia.votingWinners();a.player_speaking=c[0];for(var d=c.length,g=0;g<d;++g)u(c[g],!1,0,a.round)}break;case 10:0<
e.canceled?(a.gamestate=11,p(a.round+1)):(++a.current_nominant>=e.nominants.length&&(a.gamestate=8,a.current_nominant=0,a.player_speaking=-1),a.player_speaking=e.nominants[a.current_nominant].player_num);break;case 11:a.gamestate=12;break;case 12:a.player_speaking=mafia.whoMurdered();a.gamestate=13;0<=a.player_speaking&&u(a.player_speaking,!0,0,a.round);break;case 13:a.gamestate=15;break;case 15:a.gamestate=3;++a.round;a.current_nominant=-1;a.table_opener=mafia.nextPlayer(a.table_opener);break;case 22:case 23:a.gamestate=
25;break;case 25:a.gamestate=0>=mafia.playersCount(!1)?18:17,mafia.submit();case 17:case 18:return}n(1,b)};this.back=function(){var a=f.game,b=a.log.length-1;if(0<=b){var a=f.game,b=a.log[b],c=0;1>=b.type&&(c|=1);25==a.gamestate&&(c|=4);if(2==b.type){var d=a.players[b.player];4<=d.warnings?(d.warnings=3,x(b.player)):3==d.warnings?(d.warnings=2,d.mute=-1):0<d.warnings&&--d.warnings}else if(3==b.type||4==b.type)x(b.player);else if(5==b.type)d=a.players[b.player],d.mute=b.round;else if(6==b.type)e.canceled=
0;else if(7==b.type)0<b.player?e.canceled=b.player:F(!1);else{switch(b.gamestate){case 3:switch(a.gamestate){case 5:0<=b.current_nominant&&0<e.nominants.length&&I();break;case 20:0<=b.current_nominant&&0<e.nominants.length&&I()}break;case 20:0<=b.current_nominant&&0<e.nominants.length&&I();break;case 5:1==b.type&&(a.players[b.player_speaking].mute=-1);switch(a.gamestate){case 11:1<a.votings.length&&(a.votings.pop(),e=a.votings[a.votings.length-1]);break;case 7:case 17:case 18:case 25:case 22:case 23:mafia.isKillingThisDay()&&
(d=mafia.votingWinners(),x(d[0]))}0<=b.current_nominant&&0<e.nominants.length&&I();break;case 7:switch(a.gamestate){case 11:1<a.votings.length&&(a.votings.pop(),e=a.votings[a.votings.length-1])}break;case 8:switch(a.gamestate){case 11:1<a.votings.length&&(a.votings.pop(),e=a.votings[a.votings.length-1]);break;case 7:case 17:case 18:case 25:case 22:case 23:mafia.isKillingThisDay()&&x(mafia.votingWinners()[0])}break;case 9:switch(a.gamestate){case 11:case 10:1<a.votings.length&&(a.votings.pop(),e=a.votings[a.votings.length-
1]);break;case 7:case 17:case 18:case 25:case 22:case 23:if(mafia.isKillingThisDay())for(var d=mafia.votingWinners(),g=0;g<d.length;++g)x(d[g])}break;case 10:switch(a.gamestate){case 11:1<a.votings.length&&(a.votings.pop(),e=a.votings[a.votings.length-1])}break;case 12:switch(a.gamestate){case 13:case 17:case 18:case 25:case 22:case 23:0<=a.player_speaking&&x(a.player_speaking);for(g=0;10>g;++g)a.players[g].don_check==a.round&&(a.players[g].don_check=-1)}break;case 13:switch(a.gamestate){case 15:for(g=
0;10>g;++g)a.players[g].sheriff_check==a.round&&(a.players[g].sheriff_check=-1)}break;case 15:switch(a.gamestate){case 3:a.table_opener=mafia.prevPlayer(a.table_opener)}}if(12==a.gamestate)for(;a.shooting.length>a.round;)a.shooting.pop()}a.round=b.round;a.gamestate=b.gamestate;a.player_speaking=b.player_speaking;a.current_nominant=b.current_nominant;a.log.pop();n(c)}};this.isNight=function(){switch(f.game.gamestate){case 1:case 2:case 11:case 12:case 13:case 15:return!0}return!1};this.nextPlayer=
function(a){var b=f.game;if(0>a){a=b.table_opener;for(var c=b.players[a];0!=c.state;)++a,10<=a&&(a=0),c=b.players[a];return a}for(;;){++a;10<=a&&(a=0);if(a==b.table_opener)return-1;c=b.players[a];if(0==c.state)return a}};this.prevPlayer=function(a){var b=f.game;0>a&&(a=b.table_opener);for(;;)if(--a,0>a&&(a=9),0==b.players[a].state)return a};this.guess=function(a){var b=f.game;if(0>a||10<=a)a=-1;null==b.guess3&&(b.guess3=[-1,-1,-1]);3>b.guess3.length?b.guess3.push(a):(b.guess3[0]=b.guess3[1],b.guess3[1]=
b.guess3[2],b.guess3[2]=a);k();null!=h&&h(0)};this.isGuessed=function(a){var b=f.game;if(null!=b.guess3)for(var c=0;c<b.guess3.length&&3>c;++c)if(b.guess3[c]==a)return!0;return!1};this.noGuess=function(){var a=f.game;if(null!=a.guess3)for(var b=0;b<a.guess3.length;++b)a.guess3[b]=-1;k();null!=h&&h(0)};this.bestPlayer=function(a){var b=f.game;if(0>a||10<=a)a=-1;b.best_player=a;k();null!=h&&h(0)};this.bestMove=function(a){var b=f.game;if(0>a||10<=a)a=-1;b.best_move=a;k();null!=h&&h(0)};this.vote=function(a,
b){var c=f.game;0==c.players[a].state&&(H(a,b?c.current_nominant:-1),k(),null!=h&&h(0))};this.canDonCheck=function(){var a=f.game,b;for(b in a.players){var c=a.players[b];if(3==c.role){if(0==c.state||1==c.state&&c.kill_round==a.round&&0==c.kill_reason)return!0;break}}return!1};this.canSheriffCheck=function(){var a=f.game,b;for(b in a.players){var c=a.players[b];if(1==c.role){if(0==c.state||1==c.state&&c.kill_round==a.round&&0==c.kill_reason)return!0;break}}return!1};this.setPlayerRole=function(a,
b){var c=f.game;if(1==c.gamestate){var d=c.players[a];if(b!=d.role){for(var e=9;0<=e;--e){var h=c.players[e];if(h.role==b){h.role=d.role;break}}d.role=b;n(0)}}};this.isKillingThisDay=function(){return 0<f.game.round||0==(mafia.gameRules.flags&4)};this.isDefenciveRoundThisDay=function(){return 0!=(mafia.gameRules.flags&1)&&mafia.isKillingThisDay()};this.warnPlayer=function(a){var b=f.game;switch(b.gamestate){case 17:case 18:case 22:case 23:case 25:return}var c=b.players[a];if(0==c.state){var d={type:2,
round:b.round,gamestate:b.gamestate,player_speaking:b.player_speaking,current_nominant:b.current_nominant,player:a};switch(++c.warnings){case 3:if(mafia.gameRules.flags&8192)c.mute=b.round+1;else switch(b.gamestate){case 0:case 1:case 2:case 3:case 20:case 21:c.mute=b.round;break;case 5:c.mute=b.round;b.player_speaking>=b.table_opener?a<=b.player_speaking&&a>=b.table_opener&&++c.mute:(a<=b.player_speaking||a>=b.table_opener)&&++c.mute;break;default:c.mute=b.round+1}break;case 4:u(a,mafia.isNight(),
2,b.round)}n(0,d)}};this.nominatePlayer=function(a){var b=f.game;if(5==b.gamestate||3==b.gamestate&&0!=(mafia.gameRules.flags&16))if(0>a||0==b.players[a].state)b.current_nominant=a,n(0)};this.suicide=function(a){var b=f.game;switch(b.gamestate){case 17:case 18:case 22:case 23:case 25:return}var c={type:3,round:b.round,gamestate:b.gamestate,player_speaking:b.player_speaking,current_nominant:b.current_nominant,player:a};u(a,mafia.isNight(),1,b.round);n(0,c)};this.kickOut=function(a){var b=f.game;switch(b.gamestate){case 17:case 18:case 22:case 23:case 25:return}var c=
{type:4,round:b.round,gamestate:b.gamestate,player_speaking:b.player_speaking,current_nominant:b.current_nominant,player:a};u(a,mafia.isNight(),3,b.round);n(0,c)};this.donCheck=function(a){var b=f.game;if(13==b.gamestate){for(var c=0;10>c;++c){var d=b.players[c];d.don_check==b.round&&(d.don_check=-1)}0<=a&&(b.players[a].don_check=b.round);b.current_nominant=a;n(0)}};this.sheriffCheck=function(a){var b=f.game;if(15==b.gamestate){for(var c=0;10>c;++c){var d=b.players[c];d.sheriff_check==b.round&&(d.sheriff_check=
-1)}0<=a&&(b.players[a].sheriff_check=b.round);b.current_nominant=a;n(0)}};this.arrangePlayer=function(a,b){var c=f.game;if(2==c.gamestate){var d=c.players[a];if(d.arranged!=b){if(0<=b)for(var e=0;10>e;++e){var h=c.players[e];h.arranged==b&&(h.arranged=-1)}d.arranged=b;n(0)}}};this.shots=function(){var a=f.game;if("undefined"==typeof a.shooting[a.round]){for(var b={},c=-1,d=0;10>d;++d){var e=a.players[d];0==e.state&&(e.arranged==a.round&&(c=d),2<=e.role&&(b[d]=c))}for(d in b)b[d]=c;a.shooting[a.round]=
b}return a.shooting[a.round]};this.shoot=function(a,b){if(12==f.game.gamestate){var c=mafia.shots();if("undefined"!=typeof b)c[b]=a;else for(var d in c)c[d]=a;k();null!=h&&h(1)}};this.restart=function(){var a=f.game;a.best_player=-1;a.best_move=-1;a.guess3=null;B||(a.start_time=a.end_time=0);a.gamestate=0;a.round=a.player_speaking=a.table_opener=a.current_nominant=a.votings=a.shooting=a.log=null;for(var b=a.flags=0;10>b;++b){var c=a.players[b];c.mute=-1;c.role=c.warnings=c.state=0;c.kill_round=c.kill_reason=
c.arranged=c.don_check=c.sheriff_check=-1}e=null;k();null!=h&&h(1)};this.votingKillAll=function(a){var b=e.multiple_kill;"undefined"!=typeof a&&9==f.game.gamestate&&(e.multiple_kill=a,h(0));return b};this.curVoting=function(){return e};this.postponeMute=function(){var a=f.game,b=a.players[a.player_speaking];b.mute==a.round&&(++b.mute,n(1,{type:5,round:a.round,gamestate:a.gamestate,player_speaking:a.player_speaking,current_nominant:a.current_nominant,player:a.player_speaking}))};this.toggleVoting=
function(){if(null!=e){var a=f.game,a={round:a.round,gamestate:a.gamestate,player_speaking:a.player_speaking,current_nominant:a.current_nominant,player:-1};0<e.canceled?(a.type=7,1<e.canceled&&F(!0),a.player=e.canceled,e.canceled=0):(a.type=6,e.canceled=1);n(1,a)}};this.submit=function(){var a=f.game;if(17<=a.gamestate&&18>=a.gamestate){var b=f,c=void 0,d=f.club,g=d.langs,m=f.user,j=d.events[f.game.event_id],n=j.flags&8?0:m.id;"undefined"==typeof c&&(c=0);"undefined"!=typeof j&&(g=j.langs,0==(j.flags&
8)&&(mid=m.id));0!=(g-1&g)&&(g=0);c={id:c,club_id:d.id,user_id:m.id,moder_id:n,lang:g,event_id:f.game.event_id,start_time:0,end_time:0,players:[],gamestate:0,round:null,player_speaking:null,table_opener:null,current_nominant:null,votings:null,shooting:null,log:null,flags:0,best_player:-1,best_move:-1,guess3:null,rules_id:f.game.rules_id};for(d=0;10>d;++d)c.players.push({id:0,number:d,nick:"",is_male:1,has_immunity:0,role:0,warnings:0,state:0,kill_round:-1,kill_reason:-1,arranged:-1,don_check:-1,sheriff_check:-1,
mute:-1});b.game=c;e=null;if(0!=a.event_id){b={action:"submit-game",time:mafia.time(),game:a};f.requests.push(b);for(b=0;10>b;++b)c=a.players[b],0!=c.id&&(f.club.players[c.id].flags=1==c.state&&0==c.kill_round&&0==c.kill_reason?f.club.players[c.id].flags|1024:f.club.players[c.id].flags&-1025)}k();0!=f.user.settings.g_autosave?http.connected()?mafia.sync():mafia.save():0!=f.user.settings.l_autosave&&mafia.save();null!=h&&h(1)}};this.settings=function(a,b,c){var d=f.user.settings;a=10*Math.floor(a/
10);b=60*Math.floor(b/60);if(d.flags!=c||d.l_autosave!=a||d.g_autosave!=b)d.flags=c,d.l_autosave=a,d.g_autosave=b,f.requests.push({action:"settings",l_autosave:a,g_autosave:a,flags:c}),k()};this.votingWinner=function(a,b){if(0<=a&&a<e.nominants.length&&f.game.flags&2){var c=e.nominants[a].count;"number"==typeof b&&(e.nominants[a].count=b,r=null,n(0));return c}return 0}};
